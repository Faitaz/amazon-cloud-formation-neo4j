#!/bin/bash

if [ -z "${RESOURCE_GROUP}" ]; then
    export RESOURCE_GROUP=RG-testdeploy
fi
if [ -z "${DEPLOYMENT}" ]; then
    # DEPLOYMENT="neo4j-$(TZ=0 date +'Neo4j-HA-%Y%m%dT%H%M%SZ')"
    DEPLOYMENT=neo4j-testdeploy
fi
if [ -z "${LOCATION}" ]; then
    LOCATION="East US"
fi

PARAMETERS=$(cat)

#echo "$PARAMETERS"
#exit

if ! az group show --name "${RESOURCE_GROUP}" &> /dev/null; then
    if ! az group create --name "${RESOURCE_GROUP}" --location "${LOCATION}"; then
        exit $?
    fi
fi

# Copy latest testing templates to S3
bin/deploy-content.sh

# az group deployment create\
#     --template-uri "https://s3.amazonaws.com/neo4j-arm/test/mainTemplate.json" \
#     -p "${PARAMETERS}" -g "${RESOURCE_GROUP}" -n "${DEPLOYMENT}"
echo "${PARAMETERS}" > .parameters.json
echo az group deployment create \
    --template-file arm/mainTemplate.json \
    --parameters @./.parameters.json \
    --resource-group "${RESOURCE_GROUP}" \
    --name "${DEPLOYMENT}"
exit $?
