{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "Location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]"
        },

        "ClusterNamePrefix": {
            "type": "string",
            "minLength": 1,
            "maxLength": 11,
            "metadata": {
                "description": "Storage Account is most restrictive at 24 char name cap, UniqueID is 13, so 24-13=11."
            }
        },

        "VmCount": {
            "type": "int",
            "minValue": 3,
            "defaultValue": 3
        },

        "VmSize": {
            "type": "string"
        },

        "AdminUserName": {
            "type": "securestring"
        },

        "AdminAuthType": {
            "type": "string",
            "allowedValues": [ "sshpublickey", "password" ]
        },

        "AdminCredential": {
            "type": "securestring",
            "defaultValue": null
        },

        "VNetNewOrExisting": {
            "type": "string",
            "allowedValues": [ "new", "existing" ]
        },

        "VNetName": {
            "type": "string"
        },

        "VNetAddressPrefix": {
            "type": "string"
        },

        "VNetResourceGroupName": {
            "type": "string"
        },

        "SubnetName": {
            "type": "string"
        },

        "SubnetAddressPrefix": {
            "type": "string"
        },

        "SubnetStartAddress": {
            "type": "string"
        },

        "PublicIPNewOrExistingOrNone": {
            "type": "string",
            "allowedValues": [ "new", "existing", "none" ]
        },

        "PublicIPAllocationMethod": {
            "type": "string",
            "allowedValues": [ "Static", "Dynamic" ],
            "defaultValue": "Dynamic"
        },

        "sslCert": {
            "type": "string",
            "defaultValue": ""
        },

        "sslKey": {
            "type": "securestring",
            "defaultValue": ""
        },

        "Neo4jVersion": {
            "type": "string",
            "defaultValue": ""
        },

        "Neo4jPassword": {
            "type": "securestring",
            "defaultValue": ""
        },

        "Neo4jBoltPort": {
            "type": "int",
            "defaultValue": 7687,
            "metadata": {
                "description": "The port to use for (public) BOLT access to the primary instance."
            }
        },

        "Neo4jHttpsPort": {
            "type": "int",
            "defaultValue": 7473,
            "metadata": {
                "description": "The port to use for (public) HTTPS access."
            }
        },

        "Neo4jHttpPort": {
            "type": "int",
            "defaultValue": 7474,
            "metadata": {
                "description": "The port to use for (private) HTTP access. This is used by the load balancer probes. Must not conflict with other ports."
            }
        },

        "Neo4JTags": {
            "type": "object",
            "defaultValue": {
                "provider": "B9442746-5BFF-4E2F-BC90-1F49C5791FAA",
                "neo4jURL": "https://neo4j.com/",
                "licensing": "https://neo4j.com/licensing"
            },
            "metadata": {
                "description": "Azure Marketplace usage ID (do not change)"
            }
        },

        "ArtifactsBase": {
            "type": "string",
            "metadata": {
                "artifactsBaseUrl": "",
                "description": "Base URL at which Marketplace package files are stored. Do not remove or change. Value adjusted automatically during Marketplace submission process."
            },
            "defaultValue": "https://s3.amazonaws.com/neo4j-arm/test"
        }
    },
    "variables": {
        "artifactsBase": "[concat(parameters('ArtifactsBase'),'/')]",
        "Neo4JTags": {
            "provider": "[toUpper(parameters('Neo4JTags').provider)]"
        }
    },
    "resources": [
        {
            "comments": "Build the VMs, including the needed resources such as Storage Accounts, VNET, etc.",
            "type": "Microsoft.Resources/deployments",
            "name": "CreateNeo4jClusterVMs",
            "apiVersion": "2017-05-10",
            "dependsOn": [],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('artifactsBase'), 'clusterTemplate.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "ClusterNamePrefix": {
                        "value": "[parameters('ClusterNamePrefix')]"
                    },
                    "VmCount": {
                        "value": "[parameters('VmCount')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "AdminUserName": {
                        "value": "[parameters('AdminUserName')]"
                    },
                    "AdminAuthType": {
                        "value": "[parameters('AdminAuthType')]"
                    },
                    "AdminCredential": {
                        "value": "[parameters('AdminCredential')]"
                    },
                    "VNetNewOrExisting": {
                        "value": "[parameters('VNetNewOrExisting')]"
                    },
                    "VNetName": {
                        "value": "[parameters('VNetName')]"
                    },
                    "VNetAddressPrefix": {
                        "value": "[parameters('VNetAddressPrefix')]"
                    },
                    "VNetResourceGroupName": {
                        "value": "[parameters('VNetResourceGroupName')]"
                    },
                    "SubnetName": {
                        "value": "[parameters('SubnetName')]"
                    },
                    "SubnetAddressPrefix": {
                        "value": "[parameters('SubnetAddressPrefix')]"
                    },
                    "SubnetStartAddress": {
                        "value": "[parameters('SubnetStartAddress')]"
                    },
                    "PublicIPNewOrExistingOrNone": {
                        "value": "[parameters('PublicIPNewOrExistingOrNone')]"
                    },
                    "PublicIPAllocationMethod": {
                        "value": "[parameters('PublicIPAllocationMethod')]"
                    },
                    "sslCert": {
                        "value": "[parameters('sslCert')]"
                    },
                    "sslKey": {
                        "value": "[parameters('sslKey')]"
                    },
                    "Neo4jVersion": {
                        "value": "[parameters('Neo4jVersion')]"
                    },
                    "Neo4jPassword": {
                        "value": "[parameters('Neo4jPassword')]"
                    },
                    "Neo4jBoltPort": {
                        "value": "[parameters('Neo4jBoltPort')]"
                    },
                    "Neo4jHttpsPort": {
                        "value": "[parameters('Neo4jHttpsPort')]"
                    },
                    "Neo4jHttpPort": {
                        "value": "[parameters('Neo4jHttpPort')]"
                    },
                    "ArtifactsBase": {
                        "value": "[parameters('ArtifactsBase')]"
                    },
                    "Neo4JTags": {
                        "value": "[variables('Neo4JTags')]"
                    }
                }
            }
        }
    ]
}
